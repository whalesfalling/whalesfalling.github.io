
<!DOCTYPE html>
<html lang="zh-CN" class="loading">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IDEA SPringBoot 整合H5微信支付 - Whale Fall·T</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate">
    <meta name="keywords" content="TriDiamond Obsidian,"> 
    <meta name="description" content="路漫漫其修远兮，吾将上下而求索,前言​        上周由于项目需要开通H5微信支付功能，于是在网上参考了很多例子，由于数据缺失，实用性不高，所以在此特地将SpringBoot整合H5微信支付的流程整理成文档，测试可用。
场景介,"> 
    <meta name="author" content="罗韬"> 
    <link rel="alternative" href="atom.xml" title="Whale Fall·T" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link href="https://fonts.loli.net/css?family=Roboto+Mono|Rubik&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_1429596_nzgqgvnmkjb.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.7.2/animate.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/codemirror.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/theme/dracula.css">
    <link rel="stylesheet" href="/css/obsidian.css">
    <link rel="stylesheet" href="/css/ball-atom.min.css">
</head>
</html>

<body class="loading">
    <div class="loader">
        <div class="la-ball-atom la-2x">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <span id="config-title" style="display:none">Whale Fall·T</span>
    <div id="loader"></div>
    <div id="single">
    <div class="scrollbar gradient-bg-rev"></div>
<div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <div class="navigation animated fadeIn fast delay-1s">
        <img id="home-icon" class="icon-home" src="/img/favicon.png" alt="" data-url="https://whalesfalling.github.io">
        <div id="play-icon" title="Play/Pause" class="iconfont icon-play"></div>
        <h3 class="subtitle">IDEA SPringBoot 整合H5微信支付</h3>
        <div class="social">
            <!--        <div class="like-icon">-->
            <!--            <a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
            <!--        </div>-->
            <div>
                <div class="share">
                    
                        <a href="javascript:;" class="iconfont icon-share1"></a>
                        <div class="share-component-cc" data-disabled="facebook,douban,linkedin,diandian,tencent,google"></div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="section">
        <div class=article-header-wrapper>
    <div class="article-header">
        <div class="article-cover animated fadeIn" style="
            animation-delay: 600ms;
            animation-duration: 1.2s;
            background-image: 
                radial-gradient(ellipse closest-side, rgba(0, 0, 0, 0.65), #100e17),
                url(/img/cover.jpg) ">
        </div>
        <div class="else">
            <p class="animated fadeInDown">
                
                <a href="/categories/支付集成"><b>「
                    </b>支付集成<b> 」</b></a>
                
                三月 25, 2019
            </p>
            <h3 class="post-title animated fadeInDown"><a href="/2019/03/25/IDEA-SPringBoot-H5WXZF.html" title="IDEA SPringBoot 整合H5微信支付">IDEA SPringBoot 整合H5微信支付</a>
            </h3>
            
            <p class="post-count animated fadeInDown">
                
                <span>
                    <b class="iconfont icon-text2"></b> <i>文章字数</i>
                    65k
                </span>
                
                
                <span>
                    <b class="iconfont icon-timer__s"></b> <i>阅读约需</i>
                    1:01
                </span>
                
                
                <span id="/2019/03/25/IDEA-SPringBoot-H5WXZF.html" class="leancloud_visitors" data-flag-title="IDEA SPringBoot 整合H5微信支付">
                    <b class="iconfont icon-read"></b> <i>阅读次数</i>
                    <span class="leancloud-visitors-count">1000000</span>
                </span>
                
                
            </p>
            
            
            <ul class="animated fadeInDown post-tags-list"><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/tags/H5微信支付/">H5微信支付</a></li></ul>
            
        </div>
    </div>
</div>

<div class="screen-gradient-after">
    <div class="screen-gradient-content">
        <div class="screen-gradient-content-inside">
            <div class="bold-underline-links screen-gradient-sponsor">
                <p>
                    <span class="animated fadeIn delay-1s"></span>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="article">
    <div class='main'>
        <div class="content markdown animated fadeIn">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​        上周由于项目需要开通H5微信支付功能，于是在网上参考了很多例子，由于数据缺失，实用性不高，所以在此特地将SpringBoot整合H5微信支付的流程整理成文档，测试可用。</p>
<h3 id="场景介绍"><a href="#场景介绍" class="headerlink" title="场景介绍"></a>场景介绍</h3><p>​          H5支付是指商户在<a href="https://www.baidu.com/s?wd=%E5%BE%AE%E4%BF%A1%E5%AE%A2%E6%88%B7%E7%AB%AF&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">微信客户端</a>外的移动端网页展示商品或服务，用户在前述页面确认使用<a href="https://www.baidu.com/s?wd=%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">微信支付</a>时，商户发起本服务呼起微信客户端进行支付。</p>
<p>​        主要用于触屏版的<a href="https://www.baidu.com/s?wd=%E6%89%8B%E6%9C%BA%E6%B5%8F%E8%A7%88%E5%99%A8&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">手机浏览器</a>请求微信支付的场景。可以方便的从外部浏览器唤起微信支付。</p>
<p>​        申请入口：登录商户平台–&gt;产品中心–&gt;我的产品–&gt;支付产品–&gt;H5支付</p>
<p>​        注意：需要开通H5支付，并且做一些配置</p>
<p>​        微信官方体验链接：<a href="https://wxpay.wxutil.com/mch/pay/h5.v2.php" target="_blank" rel="noopener">https://wxpay.wxutil.com/mch/pay/h5.v2.php</a>，请在微信外浏览器打开。</p>
<p><img src="/2019/03/25/IDEA-SPringBoot-H5WXZF/20180618211305841.png" alt="微信流程图" title="微信流程图"></p>
<p>1、用户在商户侧完成下单，使用微信支付进行支付</p>
<p>2、由商户后台向微信支付发起下单请求（调用统一下单接口）注：交易类型trade_type=MWEB</p>
<p>3、统一下单接口返回支付相关参数给商户后台，如支付跳转url（参数名“mweb_url”），商户通过mweb_url调起微信支付中间页</p>
<p>4、中间页进行H5权限的校验，安全性检查（此处常见错误请见下文）</p>
<p>5、如支付成功，商户后台会接收到微信侧的异步通知</p>
<p>6、用户在微信支付收银台完成支付或取消支付,返回商户页面（默认为返回支付发起页面）</p>
<p>7、商户在展示页面，引导用户主动发起支付结果的查询</p>
<p>8、商户后台判断是否接到收微信侧的支付结果通知，如没有，后台调用我们的订单查询接口确认订单状态</p>
<p>9、展示最终的订单支付结果给用户</p>
<p><a href="https://pay.weixin.qq.com/wiki/doc/api/H5.php?chapter=1_1" target="_blank" rel="noopener">H5支付文档</a></p>
<h3 id="集成H5微信支付"><a href="#集成H5微信支付" class="headerlink" title="集成H5微信支付"></a>集成H5微信支付</h3><h4 id="1-导入依赖jar包"><a href="#1-导入依赖jar包" class="headerlink" title="1.导入依赖jar包"></a>1.导入依赖jar包</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.wxpay<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>wxpay-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.webjars<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jquery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="2-application-yml"><a href="#2-application-yml" class="headerlink" title="2. application.yml"></a>2. application.yml</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 测试账号</span><br><span class="line">pay:</span><br><span class="line">  wxpay:</span><br><span class="line">     appID: wxab8acb865bb1637e</span><br><span class="line">     mchID: 11473623</span><br><span class="line">     key: 2ab9071b06b9f739b950ddb41db2690d</span><br><span class="line">     sandboxKey: 3639bc1370e105aa65f10cd4fef2a3ef</span><br><span class="line">     certPath: /var/local/cert/apiclient_cert.p12</span><br><span class="line">     notifyUrl: http://65ta5j.natappfree.cc/wxpay/refund/notify</span><br><span class="line">     useSandbox: true</span><br><span class="line">spring:</span><br><span class="line">  thymeleaf:</span><br><span class="line">    prefix: classpath:/templates/</span><br><span class="line">    suffix: .html</span><br><span class="line">    mode: HTML5</span><br><span class="line">    encoding: UTF-8</span><br></pre></td></tr></table></figure>
<h4 id="3-WebMvcConfiguration"><a href="#3-WebMvcConfiguration" class="headerlink" title="3. WebMvcConfiguration"></a>3. WebMvcConfiguration</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfiguration</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurationSupport</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addViewController(<span class="string">"/gotoWapPage"</span>).setViewName(<span class="string">"gotoWapPay"</span>);</span><br><span class="line">        registry.addViewController(<span class="string">"/gotoPagePage"</span>).setViewName(<span class="string">"gotoPagePay"</span>);</span><br><span class="line">        registry.addViewController(<span class="string">"/gotoH5Page"</span>).setViewName(<span class="string">"gotoH5Page"</span>);</span><br><span class="line">        registry.addViewController(<span class="string">"/h5PaySuccess"</span>).setViewName(<span class="string">"h5PaySuccess"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.addViewControllers(registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addResourceHandler(<span class="string">"/webjars/**"</span>).addResourceLocations(<span class="string">"classpath:/META-INF/resources/webjars/"</span>);</span><br><span class="line">        <span class="keyword">super</span>.addResourceHandlers(registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-MyWXPayConfig"><a href="#4-MyWXPayConfig" class="headerlink" title="4. MyWXPayConfig"></a>4. MyWXPayConfig</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信支付的参数配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mengday zhang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"pay.wxpay"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWXPayConfig</span> <span class="keyword">implements</span> <span class="title">WXPayConfig</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 公众账号ID */</span></span><br><span class="line">    <span class="keyword">private</span> String appID;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 商户号 */</span></span><br><span class="line">    <span class="keyword">private</span> String mchID;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** API 密钥 */</span></span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** API 沙箱环境密钥 */</span></span><br><span class="line">    <span class="keyword">private</span> String sandboxKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** API证书绝对路径 */</span></span><br><span class="line">    <span class="keyword">private</span> String certPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 退款异步通知地址 */</span></span><br><span class="line">    <span class="keyword">private</span> String notifyUrl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Boolean useSandbox;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** HTTP(S) 连接超时时间，单位毫秒 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> httpConnectTimeoutMs = <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** HTTP(S) 读数据超时时间，单位毫秒 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> httpReadTimeoutMs = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取商户证书内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 商户证书内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getCertStream</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        File certFile = <span class="keyword">new</span> File(certPath);</span><br><span class="line">        InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            inputStream = <span class="keyword">new</span> FileInputStream(certFile);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            log.error(<span class="string">"cert file not found, path=&#123;&#125;, exception is:&#123;&#125;"</span>, certPath, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> inputStream;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (useSandbox) &#123;</span><br><span class="line">            <span class="keyword">return</span> sandboxKey;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-WXPayClient"><a href="#5-WXPayClient" class="headerlink" title="5. WXPayClient"></a>5. WXPayClient</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WXPayClient</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 对WXPay的简单封装，处理支付密切相关的逻辑.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mengday Zhang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/6/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WXPayClient</span> <span class="keyword">extends</span> <span class="title">WXPay</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 密钥算法 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ALGORITHM = <span class="string">"AES"</span>;</span><br><span class="line">    <span class="comment">/** 加解密算法/工作模式/填充方式 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ALGORITHM_MODE_PADDING = <span class="string">"AES/ECB/PKCS5Padding"</span>;</span><br><span class="line">    <span class="comment">/** 用户支付中，需要输入密码 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ERR_CODE_USERPAYING = <span class="string">"USERPAYING"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ERR_CODE_AUTHCODEEXPIRE = <span class="string">"AUTHCODEEXPIRE"</span>;</span><br><span class="line">    <span class="comment">/** 交易状态: 未支付 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_STATE_NOTPAY = <span class="string">"NOTPAY"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 用户输入密码，尝试30秒内去查询支付结果 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer remainingTimeMs = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> WXPayConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WXPayClient</span><span class="params">(WXPayConfig config, WXPayConstants.SignType signType, <span class="keyword">boolean</span> useSandbox)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(config, signType, useSandbox);</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 刷卡支付</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 对WXPay#microPay(Map)增加了当支付结果为USERPAYING时去轮询查询支付结果的逻辑处理</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 注意：该方法没有处理return_code=FAIL的情况，暂时不考虑网络问题，这种情况直接返回错误</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reqData</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">microPayWithPOS</span><span class="params">(Map&lt;String, String&gt; reqData)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 开始时间(毫秒)</span></span><br><span class="line">        <span class="keyword">long</span> startTimestampMs = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; responseMapForPay = <span class="keyword">super</span>.microPay(reqData);</span><br><span class="line">        log.info(responseMapForPay.toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// // 先判断 协议字段返回(return_code)，再判断 业务返回，最后判断 交易状态(trade_state)</span></span><br><span class="line">        <span class="comment">// 通信标识，非交易标识</span></span><br><span class="line">        String returnCode = responseMapForPay.get(<span class="string">"return_code"</span>);</span><br><span class="line">        <span class="keyword">if</span> (WXPayConstants.SUCCESS.equals(returnCode)) &#123;</span><br><span class="line">            String errCode = responseMapForPay.get(<span class="string">"err_code"</span>);</span><br><span class="line">            <span class="comment">// 余额不足，信用卡失效</span></span><br><span class="line">            <span class="keyword">if</span> (ERR_CODE_USERPAYING.equals(errCode) || <span class="string">"SYSTEMERROR"</span>.equals(errCode) || <span class="string">"BANKERROR"</span>.equals(errCode)) &#123;</span><br><span class="line">                Map&lt;String, String&gt; orderQueryMap = <span class="keyword">null</span>;</span><br><span class="line">                Map&lt;String, String&gt; requestData = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                requestData.put(<span class="string">"out_trade_no"</span>, reqData.get(<span class="string">"out_trade_no"</span>));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 用户支付中，需要输入密码或系统错误则去重新查询订单API err_code, result_code, err_code_des</span></span><br><span class="line">                <span class="comment">// 每次循环时的当前系统时间 - 开始时记录的时间 &gt; 设定的30秒时间就退出</span></span><br><span class="line">                <span class="keyword">while</span> (System.currentTimeMillis() - startTimestampMs &lt; remainingTimeMs) &#123;</span><br><span class="line">                    <span class="comment">// 商户收银台得到USERPAYING状态后，经过商户后台系统调用【查询订单API】查询实际支付结果。</span></span><br><span class="line">                    orderQueryMap = <span class="keyword">super</span>.orderQuery(requestData);</span><br><span class="line">                    String returnCodeForQuery = orderQueryMap.get(<span class="string">"return_code"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (WXPayConstants.SUCCESS.equals(returnCodeForQuery)) &#123;</span><br><span class="line">                        <span class="comment">// 通讯成功</span></span><br><span class="line">                        String tradeState = orderQueryMap.get(<span class="string">"trade_state"</span>);</span><br><span class="line">                        <span class="keyword">if</span> (WXPayConstants.SUCCESS.equals(tradeState)) &#123;</span><br><span class="line">                            <span class="comment">// 如果成功了直接将查询结果返回</span></span><br><span class="line">                            <span class="keyword">return</span> orderQueryMap;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 如果支付结果仍为USERPAYING，则每隔5秒循环调用【查询订单API】判断实际支付结果</span></span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果用户取消支付或累计30秒用户都未支付，商户收银台退出查询流程后继续调用【撤销订单API】撤销支付交易。</span></span><br><span class="line">                String tradeState = orderQueryMap.get(<span class="string">"trade_state"</span>);</span><br><span class="line">                <span class="keyword">if</span> (TRADE_STATE_NOTPAY.equals(tradeState) || ERR_CODE_USERPAYING.equals(tradeState) || ERR_CODE_AUTHCODEEXPIRE.equals(tradeState)) &#123;</span><br><span class="line">                    Map&lt;String, String&gt; reverseMap = <span class="keyword">this</span>.reverse(requestData);</span><br><span class="line">                    String returnCodeForReverse = reverseMap.get(<span class="string">"return_code"</span>);</span><br><span class="line">                    String resultCode = reverseMap.get(<span class="string">"result_code"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (WXPayConstants.SUCCESS.equals(returnCodeForReverse) &amp;&amp; WXPayConstants.SUCCESS.equals(resultCode)) &#123;</span><br><span class="line">                        <span class="comment">// 如果撤销成功，需要告诉客户端已经撤销订单了</span></span><br><span class="line">                        responseMapForPay.put(<span class="string">"err_code_des"</span>, <span class="string">"用户取消支付或尚未支付，后台已经撤销该订单，请重新支付！"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> responseMapForPay;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从request的inputStream中获取参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getNotifyParameter</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        InputStream inputStream = request.getInputStream();</span><br><span class="line">        ByteArrayOutputStream outSteam = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((length = inputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            outSteam.write(buffer, <span class="number">0</span>, length);</span><br><span class="line">        &#125;</span><br><span class="line">        outSteam.close();</span><br><span class="line">        inputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取微信调用我们notify_url的返回信息</span></span><br><span class="line">        String resultXml = <span class="keyword">new</span> String(outSteam.toByteArray(), <span class="string">"utf-8"</span>);</span><br><span class="line">        Map&lt;String, String&gt; notifyMap = WXPayUtil.xmlToMap(resultXml);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> notifyMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解密退款通知</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;a href="https://pay.weixin.qq.com/wiki/doc/api/micropay.php?chapter=9_16&amp;index=11&gt;退款结果通知文档&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">decodeRefundNotify</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 从request的流中获取参数</span></span><br><span class="line">        Map&lt;String, String&gt; notifyMap = <span class="keyword">this</span>.getNotifyParameter(request);</span><br><span class="line">        log.info(notifyMap.toString());</span><br><span class="line"></span><br><span class="line">        String reqInfo = notifyMap.get(<span class="string">"req_info"</span>);</span><br><span class="line">        <span class="comment">//（1）对加密串A做base64解码，得到加密串B</span></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> BASE64Decoder().decodeBuffer(reqInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（2）对商户key做md5，得到32位小写key* ( key设置路径：微信商户平台(pay.weixin.qq.com)--&gt;账户设置--&gt;API安全--&gt;密钥设置 )</span></span><br><span class="line">        Cipher cipher = Cipher.getInstance(ALGORITHM_MODE_PADDING);</span><br><span class="line">        SecretKeySpec key = <span class="keyword">new</span> SecretKeySpec(WXPayUtil.MD5(config.getKey()).toLowerCase().getBytes(), ALGORITHM);</span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, key);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（3）用key*对加密串B做AES-256-ECB解密（PKCS7Padding）</span></span><br><span class="line">        <span class="comment">// java.security.InvalidKeyException: Illegal key size or default parameters</span></span><br><span class="line">        <span class="comment">// https://www.cnblogs.com/yaks/p/5608358.html</span></span><br><span class="line">        String responseXml = <span class="keyword">new</span> String(cipher.doFinal(bytes),<span class="string">"UTF-8"</span>);</span><br><span class="line">        Map&lt;String, String&gt; responseMap = WXPayUtil.xmlToMap(responseXml);</span><br><span class="line">        <span class="keyword">return</span> responseMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取沙箱环境验签秘钥API</span></span><br><span class="line"><span class="comment">     * &lt;a href="https://pay.weixin.qq.com/wiki/doc/api/micropay.php?chapter=23_1"&gt;获取验签秘钥API文档&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getSignKey</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; reqData = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        reqData.put(<span class="string">"mch_id"</span>, config.getMchID());</span><br><span class="line">        reqData.put(<span class="string">"nonce_str"</span>, WXPayUtil.generateNonceStr());</span><br><span class="line">        String sign = WXPayUtil.generateSignature(reqData, config.getKey(), WXPayConstants.SignType.MD5);</span><br><span class="line">        reqData.put(<span class="string">"sign"</span>, sign);</span><br><span class="line">        String responseXml = <span class="keyword">this</span>.requestWithoutCert(<span class="string">"https://api.mch.weixin.qq.com/sandboxnew/pay/getsignkey"</span>, reqData,</span><br><span class="line">                config.getHttpConnectTimeoutMs(), config.getHttpReadTimeoutMs());</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; responseMap = WXPayUtil.xmlToMap(responseXml);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> responseMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6-WXPayConfiguration"><a href="#6-WXPayConfiguration" class="headerlink" title="6. WXPayConfiguration"></a>6. WXPayConfiguration</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信支付配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mengday zhang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(MyWXPayConfig<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">WXPayConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyWXPayConfig wxPayConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * useSandbox 沙盒环境</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WXPay <span class="title">wxPay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WXPay(wxPayConfig, WXPayConstants.SignType.MD5, wxPayConfig.getUseSandbox() );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WXPayClient <span class="title">wxPayClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WXPayClient(wxPayConfig, WXPayConstants.SignType.MD5, wxPayConfig.getUseSandbox());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7-gotoH5Page-html"><a href="#7-gotoH5Page-html" class="headerlink" title="7. gotoH5Page.html"></a>7. gotoH5Page.html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">"font-size: 30px"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>购买商品：可口可乐<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>价格：4<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>数量：10个<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">style</span>=<span class="string">"width: 100%; height: 60px; alignment: center; background: #b49e8f"</span> <span class="attr">onclick</span>=<span class="string">"commitOrder()"</span>&gt;</span>提交订单<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://localhost:8080/webjars/jquery/3.3.1/jquery.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">commitOrder</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        $.ajax(&#123;</span></span><br><span class="line"><span class="javascript">            type: <span class="string">"POST"</span>,</span></span><br><span class="line"><span class="javascript">            url: <span class="string">"http://localhost:8080/wxpay/h5pay/order"</span>,</span></span><br><span class="line"><span class="javascript">            data: <span class="literal">null</span>,</span></span><br><span class="line"><span class="javascript">            success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(data);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> redirectUrl = <span class="string">"http://localhost:8080/h5PaySuccess"</span>;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> mwebUrl = data.mweb_url+<span class="string">"&amp;redirect_url="</span>+<span class="built_in">encodeURIComponent</span>(redirectUrl);</span></span><br><span class="line"><span class="javascript">                <span class="built_in">window</span>.location.href=mwebUrl;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="8-h5PaySuccess-html"><a href="#8-h5PaySuccess-html" class="headerlink" title="8. h5PaySuccess.html"></a>8. h5PaySuccess.html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>微信支付-H5支付成功<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="9-WXPayH5PayController"><a href="#9-WXPayH5PayController" class="headerlink" title="9. WXPayH5PayController"></a>9. WXPayH5PayController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信支付-H5支付.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * detailed description</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mengday Zhang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/6/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/wxpay/h5pay"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WXPayH5PayController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WXPay wxPay;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WXPayClient wxPayClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用沙箱支付的金额必须是用例中指定的金额，也就是 1.01 元，1.02元等，不能是你自己的商品的实际价格，必须是这个数。</span></span><br><span class="line"><span class="comment">     * 否则会报错：沙箱支付金额(2000)无效，请检查需要验收的case</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/order"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">h5pay</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; reqData = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        reqData.put(<span class="string">"out_trade_no"</span>, String.valueOf(System.nanoTime()));</span><br><span class="line">        reqData.put(<span class="string">"trade_type"</span>, <span class="string">"MWEB"</span>);</span><br><span class="line">        reqData.put(<span class="string">"product_id"</span>, <span class="string">"1"</span>);</span><br><span class="line">        reqData.put(<span class="string">"body"</span>, <span class="string">"商户下单"</span>);</span><br><span class="line">        <span class="comment">// 订单总金额，单位为分</span></span><br><span class="line">        reqData.put(<span class="string">"total_fee"</span>, <span class="string">"101"</span>);</span><br><span class="line">        <span class="comment">// APP和网页支付提交用户端ip，Native支付填调用微信支付API的机器IP。</span></span><br><span class="line">        reqData.put(<span class="string">"spbill_create_ip"</span>, <span class="string">"14.23.150.211"</span>);</span><br><span class="line">        <span class="comment">// 异步接收微信支付结果通知的回调地址，通知url必须为外网可访问的url，不能携带参数。</span></span><br><span class="line">        reqData.put(<span class="string">"notify_url"</span>, <span class="string">"http://3sbqi7.natappfree.cc/wxpay/h5pay/notify"</span>);</span><br><span class="line">        <span class="comment">// 自定义参数, 可以为终端设备号(门店号或收银设备ID)，PC网页或公众号内支付可以传"WEB"</span></span><br><span class="line">        reqData.put(<span class="string">"device_info"</span>, <span class="string">""</span>);</span><br><span class="line">        <span class="comment">// 附加数据，在查询API和支付通知中原样返回，可作为自定义参数使用。</span></span><br><span class="line">        reqData.put(<span class="string">"attach"</span>, <span class="string">""</span>);</span><br><span class="line">        reqData.put(<span class="string">"scene_info"</span>, <span class="string">"&#123;\"h5_info\": &#123;\"type\":\"Wap\",\"wap_url\": \"http://3sbqi7.natappfree.cc\",\"wap_name\": \"腾讯充值\"&#125;&#125;"</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; responseMap = wxPay.unifiedOrder(reqData);</span><br><span class="line">        log.info(responseMap.toString());</span><br><span class="line">        String returnCode = responseMap.get(<span class="string">"return_code"</span>);</span><br><span class="line">        String resultCode = responseMap.get(<span class="string">"result_code"</span>);</span><br><span class="line">        <span class="keyword">if</span> (WXPayConstants.SUCCESS.equals(returnCode) &amp;&amp; WXPayConstants.SUCCESS.equals(resultCode)) &#123;</span><br><span class="line">            <span class="comment">// 预支付交易会话标识</span></span><br><span class="line">            String prepayId = responseMap.get(<span class="string">"prepay_id"</span>);</span><br><span class="line">            <span class="comment">// 支付跳转链接(前端需要在该地址上拼接redirect_url,该参数不是必须的)</span></span><br><span class="line">            <span class="comment">// 正常流程用户支付完成后会返回至发起支付的页面，如需返回至指定页面，则可以在MWEB_URL后拼接上redirect_url参数，来指定回调页面</span></span><br><span class="line">            <span class="comment">// 需对redirect_url进行urlencode处理</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// TODO 正常情况下这里应该是普通的链接，不知道这里为何是weixin://这样的链接，不知道是不是微信公众平台上的配置少配置了；</span></span><br><span class="line">            <span class="comment">// 由于没有实际账号，还没找到为啥不是普通链接的原因</span></span><br><span class="line">            String mwebUrl = responseMap.get(<span class="string">"mweb_url"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> responseMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注意：如果是沙箱环境，一提交订单就会立即异步通知，而无需拉起微信支付收银台的中间页面</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/notify"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">payNotify</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; reqData = wxPayClient.getNotifyParameter(request);</span><br><span class="line">        log.info(reqData.toString());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        String returnCode = reqData.get(<span class="string">"return_code"</span>);</span><br><span class="line">        String resultCode = reqData.get(<span class="string">"result_code"</span>);</span><br><span class="line">        <span class="keyword">if</span> (WXPayConstants.SUCCESS.equals(returnCode) &amp;&amp; WXPayConstants.SUCCESS.equals(resultCode)) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> signatureValid = wxPay.isPayResultNotifySignatureValid(reqData);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (signatureValid) &#123;</span><br><span class="line">                <span class="comment">// TODO 业务处理</span></span><br><span class="line"></span><br><span class="line">                Map&lt;String, String&gt; responseMap = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">                responseMap.put(<span class="string">"return_code"</span>, <span class="string">"SUCCESS"</span>);</span><br><span class="line">                responseMap.put(<span class="string">"return_msg"</span>, <span class="string">"OK"</span>);</span><br><span class="line">                String responseXml = WXPayUtil.mapToXml(responseMap);</span><br><span class="line"></span><br><span class="line">                response.setContentType(<span class="string">"text/xml"</span>);</span><br><span class="line">                response.getWriter().write(responseXml);</span><br><span class="line">                response.flushBuffer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><h4 id="1-Data-Slf4j标签的引用"><a href="#1-Data-Slf4j标签的引用" class="headerlink" title="1.@Data @Slf4j标签的引用"></a>1.@Data @Slf4j标签的引用</h4><p>   参考  <a href="https://jingyan.baidu.com/article/0a52e3f4e53ca1bf63ed725c.html" target="_blank" rel="noopener">IntelliJ IDEA lombok插件的安装和使用</a></p>
<h4 id="2-微信支付常见错误"><a href="#2-微信支付常见错误" class="headerlink" title="2.微信支付常见错误"></a>2.微信支付常见错误</h4><p>   参考  <a href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=9_1" target="_blank" rel="noopener">微信官方文档</a>   <a href="https://blog.csdn.net/dsn727455218/article/details/70139320" target="_blank" rel="noopener">微信支付常见问题</a>  <a href="https://pay.weixin.qq.com/wiki/doc/api/H5.php?chapter=15_4" target="_blank" rel="noopener">微信返回错误提示</a></p>
<h4 id="3-沙箱环境说明"><a href="#3-沙箱环境说明" class="headerlink" title="3.沙箱环境说明"></a>3.沙箱环境说明</h4><p>   参考  <a href="https://blog.csdn.net/qianfeng_dashuju/article/details/84067817" target="_blank" rel="noopener">浅析微信支付：如何使用沙箱环境测试</a></p>
<p>   注意：本文档中 useSandbox: true 为沙箱测试环境，返回微信地址为 weixin://这样的链接，提交订单就会立即异步通知，不会拉起微信支付收银台的中间页面，当 useSandbox: false 时，切换为生产环境，浏览器会跳转至微信支付收银台的中间页面。</p>
<h3 id="回调页面"><a href="#回调页面" class="headerlink" title="回调页面"></a>回调页面</h3><p>​       正常流程用户支付完成后会返回至发起支付的页面，如需返回至指定页面，则可以在MWEB_URL后拼接上redirect_url参数，来指定回调页面。</p>
<p>如：</p>
<p>​       您希望用户支付完成后跳转至<a href="https://www.wechatpay.com.cn，则可以做如下处理：" target="_blank" rel="noopener">https://www.wechatpay.com.cn，则可以做如下处理：</a></p>
<p>​       假设您通过统一下单接口获到的MWEB_URL= <a href="https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=wx20161110163838f231619da20804912345&amp;package=1037687096" target="_blank" rel="noopener">https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=wx20161110163838f231619da20804912345&amp;package=1037687096</a></p>
<p>​       则拼接后的地址为MWEB_URL= <a href="https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=wx20161110163838f231619da20804912345&amp;package=1037687096&amp;redirect_url=https%3A%2F%2Fwww.wechatpay.com.cn" target="_blank" rel="noopener">https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=wx20161110163838f231619da20804912345&amp;package=1037687096&amp;redirect_url=https%3A%2F%2Fwww.wechatpay.com.cn</a></p>
<p>注意：</p>
<p>注意MWEB_URL是普通的链接，不是微信weixin://短链接（useSandbox: false）<br>需对redirect_url进行urlencode处理<br>由于设置redirect_url后,回跳指定页面的操作可能发生在：</p>
<p>微信支付中间页调起微信收银台后超过5秒</p>
<p>用户点击“取消支付“或支付完成后点“完成”按钮。因此无法保证页面回跳时，支付流程已结束，所以商户设置的redirect_url地址不能自动执行查单操作，应让用户去点击按钮触发查单操作。</p>
<blockquote>
<p>本博客参考 ：<a href="https://blog.csdn.net/vbirdbest/article/details/80726616" target="_blank" rel="noopener">https://blog.csdn.net/vbirdbest/article/details/80726616</a> 原创文档</p>
</blockquote>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls"
                data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
            <ul id="audio-list" style="display:none">
                
                
                <li title='0' data-url='/statics/chengdu.mp3'></li>
                
                    
            </ul>
            
            
            
    <div id='gitalk-container' class="comment link"
        data-ae='true'
        data-ci='ec894e2b66f752e8b7fb'
        data-cs='3ccc2e92bb350688fe2c2dc2930189b62622bfb1'
        data-r='blog-comments'
        data-o='TriDiamond'
        data-a='TriDiamond'
        data-d=''
    >留言</div>


            
            
            <div id="vcomments"></div>
            
        </div>
        <div class="sidebar">
            <div class="box animated fadeInRight">
                <div class="subbox">
                    <img src="https://res.cloudinary.com/tridiamond/image/upload/v1573019751/TriDiamond_logo_ui_xeublz.jpg" height=300 width=300></img>
                    <p>罗韬</p>
                    <span>A nine story platform begins with a pile of soil; a journey of a thousand miles begins with a single step</span>
                    <dl>
                        <dd><a href="https://github.com/TriDiamond" target="_blank"><span
                                    class=" iconfont icon-github"></span></a></dd>
                        <dd><a href="https://twitter.com/TriDiamond6" target="_blank"><span
                                    class=" iconfont icon-twitter"></span></a></dd>
                        <dd><a href="https://stackoverflow.com/users/7602324/tridiamond?tab=profile" target="_blank"><span
                                    class=" iconfont icon-stack-overflow"></span></a></dd>
                    </dl>
                </div>
                <ul>
                    <li><a href="/">10 <p>文章</p></a></li>
                    <li><a href="/categories">6 <p>分类</p></a></li>
                    <li><a href="/tags">6 <p>标签</p></a></li>
                </ul>
            </div>
            
            
            
            <div class="box sticky animated fadeInRight faster">
                <div id="toc" class="subbox">
                    <h4>目录</h4>
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#场景介绍"><span class="toc-number">1.1.</span> <span class="toc-text">场景介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集成H5微信支付"><span class="toc-number">1.2.</span> <span class="toc-text">集成H5微信支付</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常见问题"><span class="toc-number">1.3.</span> <span class="toc-text">常见问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回调页面"><span class="toc-number">1.4.</span> <span class="toc-text">回调页面</span></a></li></ol></li></ol>
                </div>
            </div>
            
            
        </div>
    </div>
</div>

    </div>
</div>
    <div id="back-to-top" class="animated fadeIn faster">
        <div class="flow"></div>
        <span class="percentage animated fadeIn faster">0%</span>
        <span class="iconfont icon-top02 animated fadeIn faster"></span>
    </div>
</body>
<footer>
    <p class="copyright" id="copyright">
        &copy; 2020
        <span class="gradient-text">
            罗韬
        </span>.
        Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
        Theme
        <span class="gradient-text">
            <a href="https://github.com/TriDiamond/hexo-theme-obsidian" title="Obsidian" target="_blank" rel="noopener">Obsidian</a>
        </span>
        <small><a href="https://github.com/TriDiamond/hexo-theme-obsidian/blob/master/CHANGELOG.md" title="v1.4.4" target="_blank" rel="noopener">v1.4.4</a></small>
    </p>
</footer>

<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
    "HTML-CSS": {
      preferredFont: "TeX",
      availableFonts: ["STIX", "TeX"],
      linebreaks: {
        automatic: true
      },
      EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
      inlineMath: [
        ["$", "$"],
        ["\\(", "\\)"]
      ],
      processEscapes: true,
      ignoreClass: "tex2jax_ignore|dno",
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      noUndefined: {
        attributes: {
          mathcolor: "red",
          mathbackground: "#FFEEEE",
          mathsize: "90%"
        }
      },
      Macros: {
        href: "{}"
      }
    },
    messageStyle: "none"
  });
</script>
<script>
  function initialMathJax() {
    MathJax.Hub.Queue(function () {
      var all = MathJax.Hub.getAllJax(),
        i;
      // console.log(all);
      for (i = 0; i < all.length; i += 1) {
        console.log(all[i].SourceElement().parentNode)
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  }

  function reprocessMathJax() {
    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }
  }
</script>


 <link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css"> <script src="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/obsidian.js"></script>
<script src="/js/jquery.truncate.js"></script>
<script src="/js/search.js"></script> <script src="//cdn.bootcss.com/typed.js/2.0.10/typed.min.js"></script> <script src="//cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script> <script src="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

<script src="https://cdn.bootcss.com/codemirror/5.48.4/codemirror.min.js"></script>
 <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/javascript/javascript.min.js"></script>  <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/css/css.min.js"></script>  <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/xml/xml.min.js"></script>  <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/htmlmixed/htmlmixed.min.js"></script>  <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/clike/clike.min.js"></script>  <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/php/php.min.js"></script>  <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/shell/shell.min.js"></script>  <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/python/python.min.js"></script>   <script src="/js/busuanzi.min.js"></script>
<script>
  $(document).ready(function () {
    if ($('span[id^="busuanzi_"]').length) {
      initialBusuanzi();
    }
  });
</script>
 <link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
 
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="//www.googletagmanager.com/gtag/js?id=UA-149874671-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag('js', new Date());

  gtag('config', 'UA-149874671-1');
</script>
 

<script>
  function initialTyped() {
    var typedTextEl = $('.typed-text');
    if (typedTextEl && typedTextEl.length > 0) {
      var typed = new Typed('.typed-text', {
        strings: ['A nine story platform begins with a pile of soil; a journey of a thousand miles begins with a single step', '九层之台，始于垒土；千里之行，始于足下'],
        typeSpeed: 90,
        loop: true,
        loopCount: Infinity,
        backSpeed: 20,
      });
    }
  }

  if ($('.article-header') && $('.article-header').length) {
    $(document).ready(function () {
      initialTyped();
    });
  }
</script>

 <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script>
  var valine = new Valine();

  function initValine(path) {
    if (!path) path = window.location.pathname;
    let language = 'zh-CN';
    if (!language) {
      language = 'en';
    } else {
      language = language.toLowerCase();
    }
    valine.init({
      el: '#vcomments',
      appId: 'YwPqf3YyKiyKVGazKccpq1eN-gzGzoHsz',
      appKey: 'XcJO4tFB2gyOLWt85ndRFpCD',
      notify: 'false',
      verify: 'false',
      avatar: 'mp',
      placeholder: 'Leave your throughs behind~',
      visitor: 'true',
      path: path,
      lang: language,
    });
  }

  $(document).ready(function () {
    initValine();
  });
</script>



</html>
