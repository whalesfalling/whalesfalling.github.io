<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Whale Fall·T's blog."><meta name="keywords" content="hexo,github"><title>IDEA SPringBoot 整合H5微信支付 | Whale Fall·T 的博客</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/donate.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/style-dark.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight-dark.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css?v=2.0.3"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js?v=2.0.3"></script><script src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=2.0.3"></script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">IDEA SPringBoot 整合H5微信支付</h1><a id="logo" href="/.">Whale Fall·T 的博客</a><p class="description">或许是不知梦的缘故，流离之人追逐幻影。</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">IDEA SPringBoot 整合H5微信支付</h1><div class="post-meta"><a href="/2019/03/25/IDEA-SPringBoot-H5WXZF.html#comments" class="comment-count"><i id="changyan_count_unit" data-xid="2019/03/25/IDEA-SPringBoot-H5WXZF.html"></i>留言,<i id="changyan_parti_unit" data-xid="2019/03/25/IDEA-SPringBoot-H5WXZF.html"></i>参与</a><p><span class="date">Mar 25, 2019</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​        上周由于项目需要开通H5微信支付功能，于是在网上参考了很多例子，由于数据缺失，实用性不高，所以在此特地将SpringBoot整合H5微信支付的流程整理成文档，测试可用。</p>
<h3 id="场景介绍"><a href="#场景介绍" class="headerlink" title="场景介绍"></a>场景介绍</h3><p>​          H5支付是指商户在<a href="https://www.baidu.com/s?wd=%E5%BE%AE%E4%BF%A1%E5%AE%A2%E6%88%B7%E7%AB%AF&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">微信客户端</a>外的移动端网页展示商品或服务，用户在前述页面确认使用<a href="https://www.baidu.com/s?wd=%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">微信支付</a>时，商户发起本服务呼起微信客户端进行支付。</p>
<p>​        主要用于触屏版的<a href="https://www.baidu.com/s?wd=%E6%89%8B%E6%9C%BA%E6%B5%8F%E8%A7%88%E5%99%A8&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" target="_blank" rel="noopener">手机浏览器</a>请求微信支付的场景。可以方便的从外部浏览器唤起微信支付。</p>
<p>​        申请入口：登录商户平台–&gt;产品中心–&gt;我的产品–&gt;支付产品–&gt;H5支付</p>
<p>​        注意：需要开通H5支付，并且做一些配置</p>
<p>​        微信官方体验链接：<a href="https://wxpay.wxutil.com/mch/pay/h5.v2.php" target="_blank" rel="noopener">https://wxpay.wxutil.com/mch/pay/h5.v2.php</a>，请在微信外浏览器打开。</p>
<p><img src="/2019/03/25/D:/Hexo\whalesfalling\source\_posts\IDEA-SPringBoot-H5WXZF\20180618211305841.png" alt="微信流程图" title="微信流程图"></p>
<p>1、用户在商户侧完成下单，使用微信支付进行支付</p>
<p>2、由商户后台向微信支付发起下单请求（调用统一下单接口）注：交易类型trade_type=MWEB</p>
<p>3、统一下单接口返回支付相关参数给商户后台，如支付跳转url（参数名“mweb_url”），商户通过mweb_url调起微信支付中间页</p>
<p>4、中间页进行H5权限的校验，安全性检查（此处常见错误请见下文）</p>
<p>5、如支付成功，商户后台会接收到微信侧的异步通知</p>
<p>6、用户在微信支付收银台完成支付或取消支付,返回商户页面（默认为返回支付发起页面）</p>
<p>7、商户在展示页面，引导用户主动发起支付结果的查询</p>
<p>8、商户后台判断是否接到收微信侧的支付结果通知，如没有，后台调用我们的订单查询接口确认订单状态</p>
<p>9、展示最终的订单支付结果给用户</p>
<p><a href="https://pay.weixin.qq.com/wiki/doc/api/H5.php?chapter=1_1" target="_blank" rel="noopener">H5支付文档</a></p>
<h3 id="集成H5微信支付"><a href="#集成H5微信支付" class="headerlink" title="集成H5微信支付"></a>集成H5微信支付</h3><h4 id="1-导入依赖jar包"><a href="#1-导入依赖jar包" class="headerlink" title="1.导入依赖jar包"></a>1.导入依赖jar包</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.wxpay<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>wxpay-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.webjars<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jquery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="2-application-yml"><a href="#2-application-yml" class="headerlink" title="2. application.yml"></a>2. application.yml</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 测试账号</span><br><span class="line">pay:</span><br><span class="line">  wxpay:</span><br><span class="line">     appID: wxab8acb865bb1637e</span><br><span class="line">     mchID: 11473623</span><br><span class="line">     key: 2ab9071b06b9f739b950ddb41db2690d</span><br><span class="line">     sandboxKey: 3639bc1370e105aa65f10cd4fef2a3ef</span><br><span class="line">     certPath: /var/local/cert/apiclient_cert.p12</span><br><span class="line">     notifyUrl: http://65ta5j.natappfree.cc/wxpay/refund/notify</span><br><span class="line">     useSandbox: true</span><br><span class="line">spring:</span><br><span class="line">  thymeleaf:</span><br><span class="line">    prefix: classpath:/templates/</span><br><span class="line">    suffix: .html</span><br><span class="line">    mode: HTML5</span><br><span class="line">    encoding: UTF-8</span><br></pre></td></tr></table></figure>
<h4 id="3-WebMvcConfiguration"><a href="#3-WebMvcConfiguration" class="headerlink" title="3. WebMvcConfiguration"></a>3. WebMvcConfiguration</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfiguration</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurationSupport</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addViewController(<span class="string">"/gotoWapPage"</span>).setViewName(<span class="string">"gotoWapPay"</span>);</span><br><span class="line">        registry.addViewController(<span class="string">"/gotoPagePage"</span>).setViewName(<span class="string">"gotoPagePay"</span>);</span><br><span class="line">        registry.addViewController(<span class="string">"/gotoH5Page"</span>).setViewName(<span class="string">"gotoH5Page"</span>);</span><br><span class="line">        registry.addViewController(<span class="string">"/h5PaySuccess"</span>).setViewName(<span class="string">"h5PaySuccess"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.addViewControllers(registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addResourceHandler(<span class="string">"/webjars/**"</span>).addResourceLocations(<span class="string">"classpath:/META-INF/resources/webjars/"</span>);</span><br><span class="line">        <span class="keyword">super</span>.addResourceHandlers(registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-MyWXPayConfig"><a href="#4-MyWXPayConfig" class="headerlink" title="4. MyWXPayConfig"></a>4. MyWXPayConfig</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信支付的参数配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mengday zhang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"pay.wxpay"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWXPayConfig</span> <span class="keyword">implements</span> <span class="title">WXPayConfig</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 公众账号ID */</span></span><br><span class="line">    <span class="keyword">private</span> String appID;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 商户号 */</span></span><br><span class="line">    <span class="keyword">private</span> String mchID;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** API 密钥 */</span></span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** API 沙箱环境密钥 */</span></span><br><span class="line">    <span class="keyword">private</span> String sandboxKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** API证书绝对路径 */</span></span><br><span class="line">    <span class="keyword">private</span> String certPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 退款异步通知地址 */</span></span><br><span class="line">    <span class="keyword">private</span> String notifyUrl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Boolean useSandbox;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** HTTP(S) 连接超时时间，单位毫秒 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> httpConnectTimeoutMs = <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** HTTP(S) 读数据超时时间，单位毫秒 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> httpReadTimeoutMs = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取商户证书内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 商户证书内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getCertStream</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        File certFile = <span class="keyword">new</span> File(certPath);</span><br><span class="line">        InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            inputStream = <span class="keyword">new</span> FileInputStream(certFile);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            log.error(<span class="string">"cert file not found, path=&#123;&#125;, exception is:&#123;&#125;"</span>, certPath, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> inputStream;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (useSandbox) &#123;</span><br><span class="line">            <span class="keyword">return</span> sandboxKey;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-WXPayClient"><a href="#5-WXPayClient" class="headerlink" title="5. WXPayClient"></a>5. WXPayClient</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WXPayClient</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 对WXPay的简单封装，处理支付密切相关的逻辑.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mengday Zhang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/6/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WXPayClient</span> <span class="keyword">extends</span> <span class="title">WXPay</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 密钥算法 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ALGORITHM = <span class="string">"AES"</span>;</span><br><span class="line">    <span class="comment">/** 加解密算法/工作模式/填充方式 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ALGORITHM_MODE_PADDING = <span class="string">"AES/ECB/PKCS5Padding"</span>;</span><br><span class="line">    <span class="comment">/** 用户支付中，需要输入密码 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ERR_CODE_USERPAYING = <span class="string">"USERPAYING"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ERR_CODE_AUTHCODEEXPIRE = <span class="string">"AUTHCODEEXPIRE"</span>;</span><br><span class="line">    <span class="comment">/** 交易状态: 未支付 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_STATE_NOTPAY = <span class="string">"NOTPAY"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 用户输入密码，尝试30秒内去查询支付结果 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer remainingTimeMs = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> WXPayConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WXPayClient</span><span class="params">(WXPayConfig config, WXPayConstants.SignType signType, <span class="keyword">boolean</span> useSandbox)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(config, signType, useSandbox);</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 刷卡支付</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 对WXPay#microPay(Map)增加了当支付结果为USERPAYING时去轮询查询支付结果的逻辑处理</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 注意：该方法没有处理return_code=FAIL的情况，暂时不考虑网络问题，这种情况直接返回错误</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reqData</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">microPayWithPOS</span><span class="params">(Map&lt;String, String&gt; reqData)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 开始时间(毫秒)</span></span><br><span class="line">        <span class="keyword">long</span> startTimestampMs = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; responseMapForPay = <span class="keyword">super</span>.microPay(reqData);</span><br><span class="line">        log.info(responseMapForPay.toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// // 先判断 协议字段返回(return_code)，再判断 业务返回，最后判断 交易状态(trade_state)</span></span><br><span class="line">        <span class="comment">// 通信标识，非交易标识</span></span><br><span class="line">        String returnCode = responseMapForPay.get(<span class="string">"return_code"</span>);</span><br><span class="line">        <span class="keyword">if</span> (WXPayConstants.SUCCESS.equals(returnCode)) &#123;</span><br><span class="line">            String errCode = responseMapForPay.get(<span class="string">"err_code"</span>);</span><br><span class="line">            <span class="comment">// 余额不足，信用卡失效</span></span><br><span class="line">            <span class="keyword">if</span> (ERR_CODE_USERPAYING.equals(errCode) || <span class="string">"SYSTEMERROR"</span>.equals(errCode) || <span class="string">"BANKERROR"</span>.equals(errCode)) &#123;</span><br><span class="line">                Map&lt;String, String&gt; orderQueryMap = <span class="keyword">null</span>;</span><br><span class="line">                Map&lt;String, String&gt; requestData = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                requestData.put(<span class="string">"out_trade_no"</span>, reqData.get(<span class="string">"out_trade_no"</span>));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 用户支付中，需要输入密码或系统错误则去重新查询订单API err_code, result_code, err_code_des</span></span><br><span class="line">                <span class="comment">// 每次循环时的当前系统时间 - 开始时记录的时间 &gt; 设定的30秒时间就退出</span></span><br><span class="line">                <span class="keyword">while</span> (System.currentTimeMillis() - startTimestampMs &lt; remainingTimeMs) &#123;</span><br><span class="line">                    <span class="comment">// 商户收银台得到USERPAYING状态后，经过商户后台系统调用【查询订单API】查询实际支付结果。</span></span><br><span class="line">                    orderQueryMap = <span class="keyword">super</span>.orderQuery(requestData);</span><br><span class="line">                    String returnCodeForQuery = orderQueryMap.get(<span class="string">"return_code"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (WXPayConstants.SUCCESS.equals(returnCodeForQuery)) &#123;</span><br><span class="line">                        <span class="comment">// 通讯成功</span></span><br><span class="line">                        String tradeState = orderQueryMap.get(<span class="string">"trade_state"</span>);</span><br><span class="line">                        <span class="keyword">if</span> (WXPayConstants.SUCCESS.equals(tradeState)) &#123;</span><br><span class="line">                            <span class="comment">// 如果成功了直接将查询结果返回</span></span><br><span class="line">                            <span class="keyword">return</span> orderQueryMap;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 如果支付结果仍为USERPAYING，则每隔5秒循环调用【查询订单API】判断实际支付结果</span></span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果用户取消支付或累计30秒用户都未支付，商户收银台退出查询流程后继续调用【撤销订单API】撤销支付交易。</span></span><br><span class="line">                String tradeState = orderQueryMap.get(<span class="string">"trade_state"</span>);</span><br><span class="line">                <span class="keyword">if</span> (TRADE_STATE_NOTPAY.equals(tradeState) || ERR_CODE_USERPAYING.equals(tradeState) || ERR_CODE_AUTHCODEEXPIRE.equals(tradeState)) &#123;</span><br><span class="line">                    Map&lt;String, String&gt; reverseMap = <span class="keyword">this</span>.reverse(requestData);</span><br><span class="line">                    String returnCodeForReverse = reverseMap.get(<span class="string">"return_code"</span>);</span><br><span class="line">                    String resultCode = reverseMap.get(<span class="string">"result_code"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (WXPayConstants.SUCCESS.equals(returnCodeForReverse) &amp;&amp; WXPayConstants.SUCCESS.equals(resultCode)) &#123;</span><br><span class="line">                        <span class="comment">// 如果撤销成功，需要告诉客户端已经撤销订单了</span></span><br><span class="line">                        responseMapForPay.put(<span class="string">"err_code_des"</span>, <span class="string">"用户取消支付或尚未支付，后台已经撤销该订单，请重新支付！"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> responseMapForPay;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从request的inputStream中获取参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getNotifyParameter</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        InputStream inputStream = request.getInputStream();</span><br><span class="line">        ByteArrayOutputStream outSteam = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((length = inputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            outSteam.write(buffer, <span class="number">0</span>, length);</span><br><span class="line">        &#125;</span><br><span class="line">        outSteam.close();</span><br><span class="line">        inputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取微信调用我们notify_url的返回信息</span></span><br><span class="line">        String resultXml = <span class="keyword">new</span> String(outSteam.toByteArray(), <span class="string">"utf-8"</span>);</span><br><span class="line">        Map&lt;String, String&gt; notifyMap = WXPayUtil.xmlToMap(resultXml);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> notifyMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解密退款通知</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;a href="https://pay.weixin.qq.com/wiki/doc/api/micropay.php?chapter=9_16&amp;index=11&gt;退款结果通知文档&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">decodeRefundNotify</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 从request的流中获取参数</span></span><br><span class="line">        Map&lt;String, String&gt; notifyMap = <span class="keyword">this</span>.getNotifyParameter(request);</span><br><span class="line">        log.info(notifyMap.toString());</span><br><span class="line"></span><br><span class="line">        String reqInfo = notifyMap.get(<span class="string">"req_info"</span>);</span><br><span class="line">        <span class="comment">//（1）对加密串A做base64解码，得到加密串B</span></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> BASE64Decoder().decodeBuffer(reqInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（2）对商户key做md5，得到32位小写key* ( key设置路径：微信商户平台(pay.weixin.qq.com)--&gt;账户设置--&gt;API安全--&gt;密钥设置 )</span></span><br><span class="line">        Cipher cipher = Cipher.getInstance(ALGORITHM_MODE_PADDING);</span><br><span class="line">        SecretKeySpec key = <span class="keyword">new</span> SecretKeySpec(WXPayUtil.MD5(config.getKey()).toLowerCase().getBytes(), ALGORITHM);</span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, key);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（3）用key*对加密串B做AES-256-ECB解密（PKCS7Padding）</span></span><br><span class="line">        <span class="comment">// java.security.InvalidKeyException: Illegal key size or default parameters</span></span><br><span class="line">        <span class="comment">// https://www.cnblogs.com/yaks/p/5608358.html</span></span><br><span class="line">        String responseXml = <span class="keyword">new</span> String(cipher.doFinal(bytes),<span class="string">"UTF-8"</span>);</span><br><span class="line">        Map&lt;String, String&gt; responseMap = WXPayUtil.xmlToMap(responseXml);</span><br><span class="line">        <span class="keyword">return</span> responseMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取沙箱环境验签秘钥API</span></span><br><span class="line"><span class="comment">     * &lt;a href="https://pay.weixin.qq.com/wiki/doc/api/micropay.php?chapter=23_1"&gt;获取验签秘钥API文档&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getSignKey</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; reqData = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        reqData.put(<span class="string">"mch_id"</span>, config.getMchID());</span><br><span class="line">        reqData.put(<span class="string">"nonce_str"</span>, WXPayUtil.generateNonceStr());</span><br><span class="line">        String sign = WXPayUtil.generateSignature(reqData, config.getKey(), WXPayConstants.SignType.MD5);</span><br><span class="line">        reqData.put(<span class="string">"sign"</span>, sign);</span><br><span class="line">        String responseXml = <span class="keyword">this</span>.requestWithoutCert(<span class="string">"https://api.mch.weixin.qq.com/sandboxnew/pay/getsignkey"</span>, reqData,</span><br><span class="line">                config.getHttpConnectTimeoutMs(), config.getHttpReadTimeoutMs());</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; responseMap = WXPayUtil.xmlToMap(responseXml);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> responseMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6-WXPayConfiguration"><a href="#6-WXPayConfiguration" class="headerlink" title="6. WXPayConfiguration"></a>6. WXPayConfiguration</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信支付配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mengday zhang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(MyWXPayConfig.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WXPayConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyWXPayConfig wxPayConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * useSandbox 沙盒环境</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WXPay <span class="title">wxPay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WXPay(wxPayConfig, WXPayConstants.SignType.MD5, wxPayConfig.getUseSandbox() );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WXPayClient <span class="title">wxPayClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WXPayClient(wxPayConfig, WXPayConstants.SignType.MD5, wxPayConfig.getUseSandbox());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7-gotoH5Page-html"><a href="#7-gotoH5Page-html" class="headerlink" title="7. gotoH5Page.html"></a>7. gotoH5Page.html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">"font-size: 30px"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>购买商品：可口可乐<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>价格：4<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>数量：10个<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">style</span>=<span class="string">"width: 100%; height: 60px; alignment: center; background: #b49e8f"</span> <span class="attr">onclick</span>=<span class="string">"commitOrder()"</span>&gt;</span>提交订单<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://localhost:8080/webjars/jquery/3.3.1/jquery.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    function commitOrder() &#123;</span></span><br><span class="line"><span class="undefined">        $.ajax(&#123;</span></span><br><span class="line"><span class="undefined">            type: "POST",</span></span><br><span class="line"><span class="undefined">            url: "http://localhost:8080/wxpay/h5pay/order",</span></span><br><span class="line"><span class="undefined">            data: null,</span></span><br><span class="line"><span class="undefined">            success: function(data) &#123;</span></span><br><span class="line"><span class="undefined">                console.log(data);</span></span><br><span class="line"><span class="undefined">                var redirectUrl = "http://localhost:8080/h5PaySuccess";</span></span><br><span class="line"><span class="undefined">                var mwebUrl = data.mweb_url+"&amp;redirect_url="+encodeURIComponent(redirectUrl);</span></span><br><span class="line"><span class="undefined">                window.location.href=mwebUrl;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="8-h5PaySuccess-html"><a href="#8-h5PaySuccess-html" class="headerlink" title="8. h5PaySuccess.html"></a>8. h5PaySuccess.html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>微信支付-H5支付成功<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="9-WXPayH5PayController"><a href="#9-WXPayH5PayController" class="headerlink" title="9. WXPayH5PayController"></a>9. WXPayH5PayController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信支付-H5支付.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * detailed description</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mengday Zhang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/6/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/wxpay/h5pay"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WXPayH5PayController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WXPay wxPay;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WXPayClient wxPayClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用沙箱支付的金额必须是用例中指定的金额，也就是 1.01 元，1.02元等，不能是你自己的商品的实际价格，必须是这个数。</span></span><br><span class="line"><span class="comment">     * 否则会报错：沙箱支付金额(2000)无效，请检查需要验收的case</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/order"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">h5pay</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; reqData = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        reqData.put(<span class="string">"out_trade_no"</span>, String.valueOf(System.nanoTime()));</span><br><span class="line">        reqData.put(<span class="string">"trade_type"</span>, <span class="string">"MWEB"</span>);</span><br><span class="line">        reqData.put(<span class="string">"product_id"</span>, <span class="string">"1"</span>);</span><br><span class="line">        reqData.put(<span class="string">"body"</span>, <span class="string">"商户下单"</span>);</span><br><span class="line">        <span class="comment">// 订单总金额，单位为分</span></span><br><span class="line">        reqData.put(<span class="string">"total_fee"</span>, <span class="string">"101"</span>);</span><br><span class="line">        <span class="comment">// APP和网页支付提交用户端ip，Native支付填调用微信支付API的机器IP。</span></span><br><span class="line">        reqData.put(<span class="string">"spbill_create_ip"</span>, <span class="string">"14.23.150.211"</span>);</span><br><span class="line">        <span class="comment">// 异步接收微信支付结果通知的回调地址，通知url必须为外网可访问的url，不能携带参数。</span></span><br><span class="line">        reqData.put(<span class="string">"notify_url"</span>, <span class="string">"http://3sbqi7.natappfree.cc/wxpay/h5pay/notify"</span>);</span><br><span class="line">        <span class="comment">// 自定义参数, 可以为终端设备号(门店号或收银设备ID)，PC网页或公众号内支付可以传"WEB"</span></span><br><span class="line">        reqData.put(<span class="string">"device_info"</span>, <span class="string">""</span>);</span><br><span class="line">        <span class="comment">// 附加数据，在查询API和支付通知中原样返回，可作为自定义参数使用。</span></span><br><span class="line">        reqData.put(<span class="string">"attach"</span>, <span class="string">""</span>);</span><br><span class="line">        reqData.put(<span class="string">"scene_info"</span>, <span class="string">"&#123;\"h5_info\": &#123;\"type\":\"Wap\",\"wap_url\": \"http://3sbqi7.natappfree.cc\",\"wap_name\": \"腾讯充值\"&#125;&#125;"</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; responseMap = wxPay.unifiedOrder(reqData);</span><br><span class="line">        log.info(responseMap.toString());</span><br><span class="line">        String returnCode = responseMap.get(<span class="string">"return_code"</span>);</span><br><span class="line">        String resultCode = responseMap.get(<span class="string">"result_code"</span>);</span><br><span class="line">        <span class="keyword">if</span> (WXPayConstants.SUCCESS.equals(returnCode) &amp;&amp; WXPayConstants.SUCCESS.equals(resultCode)) &#123;</span><br><span class="line">            <span class="comment">// 预支付交易会话标识</span></span><br><span class="line">            String prepayId = responseMap.get(<span class="string">"prepay_id"</span>);</span><br><span class="line">            <span class="comment">// 支付跳转链接(前端需要在该地址上拼接redirect_url,该参数不是必须的)</span></span><br><span class="line">            <span class="comment">// 正常流程用户支付完成后会返回至发起支付的页面，如需返回至指定页面，则可以在MWEB_URL后拼接上redirect_url参数，来指定回调页面</span></span><br><span class="line">            <span class="comment">// 需对redirect_url进行urlencode处理</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// TODO 正常情况下这里应该是普通的链接，不知道这里为何是weixin://这样的链接，不知道是不是微信公众平台上的配置少配置了；</span></span><br><span class="line">            <span class="comment">// 由于没有实际账号，还没找到为啥不是普通链接的原因</span></span><br><span class="line">            String mwebUrl = responseMap.get(<span class="string">"mweb_url"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> responseMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注意：如果是沙箱环境，一提交订单就会立即异步通知，而无需拉起微信支付收银台的中间页面</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/notify"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">payNotify</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; reqData = wxPayClient.getNotifyParameter(request);</span><br><span class="line">        log.info(reqData.toString());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        String returnCode = reqData.get(<span class="string">"return_code"</span>);</span><br><span class="line">        String resultCode = reqData.get(<span class="string">"result_code"</span>);</span><br><span class="line">        <span class="keyword">if</span> (WXPayConstants.SUCCESS.equals(returnCode) &amp;&amp; WXPayConstants.SUCCESS.equals(resultCode)) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> signatureValid = wxPay.isPayResultNotifySignatureValid(reqData);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (signatureValid) &#123;</span><br><span class="line">                <span class="comment">// TODO 业务处理</span></span><br><span class="line"></span><br><span class="line">                Map&lt;String, String&gt; responseMap = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">                responseMap.put(<span class="string">"return_code"</span>, <span class="string">"SUCCESS"</span>);</span><br><span class="line">                responseMap.put(<span class="string">"return_msg"</span>, <span class="string">"OK"</span>);</span><br><span class="line">                String responseXml = WXPayUtil.mapToXml(responseMap);</span><br><span class="line"></span><br><span class="line">                response.setContentType(<span class="string">"text/xml"</span>);</span><br><span class="line">                response.getWriter().write(responseXml);</span><br><span class="line">                response.flushBuffer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><h4 id="1-Data-Slf4j标签的引用"><a href="#1-Data-Slf4j标签的引用" class="headerlink" title="1.@Data @Slf4j标签的引用"></a>1.@Data @Slf4j标签的引用</h4><p>   参考  <a href="https://jingyan.baidu.com/article/0a52e3f4e53ca1bf63ed725c.html" target="_blank" rel="noopener">IntelliJ IDEA lombok插件的安装和使用</a></p>
<h4 id="2-微信支付常见错误"><a href="#2-微信支付常见错误" class="headerlink" title="2.微信支付常见错误"></a>2.微信支付常见错误</h4><p>   参考  <a href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=9_1" target="_blank" rel="noopener">微信官方文档</a>   <a href="https://blog.csdn.net/dsn727455218/article/details/70139320" target="_blank" rel="noopener">微信支付常见问题</a>  <a href="https://pay.weixin.qq.com/wiki/doc/api/H5.php?chapter=15_4" target="_blank" rel="noopener">微信返回错误提示</a></p>
<h4 id="3-沙箱环境说明"><a href="#3-沙箱环境说明" class="headerlink" title="3.沙箱环境说明"></a>3.沙箱环境说明</h4><p>   参考  <a href="https://blog.csdn.net/qianfeng_dashuju/article/details/84067817" target="_blank" rel="noopener">浅析微信支付：如何使用沙箱环境测试</a></p>
<p>   注意：本文档中 useSandbox: true 为沙箱测试环境，返回微信地址为 weixin://这样的链接，提交订单就会立即异步通知，不会拉起微信支付收银台的中间页面，当 useSandbox: false 时，切换为生产环境，浏览器会跳转至微信支付收银台的中间页面。</p>
<h3 id="回调页面"><a href="#回调页面" class="headerlink" title="回调页面"></a>回调页面</h3><p>​       正常流程用户支付完成后会返回至发起支付的页面，如需返回至指定页面，则可以在MWEB_URL后拼接上redirect_url参数，来指定回调页面。</p>
<p>如：</p>
<p>​       您希望用户支付完成后跳转至<a href="https://www.wechatpay.com.cn，则可以做如下处理：" target="_blank" rel="noopener">https://www.wechatpay.com.cn，则可以做如下处理：</a></p>
<p>​       假设您通过统一下单接口获到的MWEB_URL= <a href="https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=wx20161110163838f231619da20804912345&amp;package=1037687096" target="_blank" rel="noopener">https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=wx20161110163838f231619da20804912345&amp;package=1037687096</a></p>
<p>​       则拼接后的地址为MWEB_URL= <a href="https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=wx20161110163838f231619da20804912345&amp;package=1037687096&amp;redirect_url=https%3A%2F%2Fwww.wechatpay.com.cn" target="_blank" rel="noopener">https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=wx20161110163838f231619da20804912345&amp;package=1037687096&amp;redirect_url=https%3A%2F%2Fwww.wechatpay.com.cn</a></p>
<p>注意：</p>
<p>注意MWEB_URL是普通的链接，不是微信weixin://短链接（useSandbox: false）<br>需对redirect_url进行urlencode处理<br>由于设置redirect_url后,回跳指定页面的操作可能发生在：</p>
<p>微信支付中间页调起微信收银台后超过5秒</p>
<p>用户点击“取消支付“或支付完成后点“完成”按钮。因此无法保证页面回跳时，支付流程已结束，所以商户设置的redirect_url地址不能自动执行查单操作，应让用户去点击按钮触发查单操作。</p>
<blockquote>
<p>本博客参考 ：<a href="https://blog.csdn.net/vbirdbest/article/details/80726616" target="_blank" rel="noopener">https://blog.csdn.net/vbirdbest/article/details/80726616</a> 原创文档</p>
</blockquote>
<script type="text/javascript" src="/js/jquery-3.3.1.js?v=2.0.3" async></script><div class="post-donate"><div id="donate_board" class="donate_bar center"><a id="btn_donate" href="javascript:;" title="打赏" class="btn_donate"></a><div class="donate_txt"> &uarr;<br>坚持原创技术分享，您的支持将鼓励我继续创作！<br></div></div><div id="donate_guide" class="donate_bar center hidden pay"><img src="/img/weixin.jpg" title="微信打赏" alt="微信打赏"><img src="/img/zhifubao.jpg" title="支付宝打赏" alt="支付宝打赏"></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
    $('#donate_board').addClass('hidden');
    $('#donate_guide').removeClass('hidden');
}</script></div></div><div class="post-copyright"><blockquote><p>原文作者: 罗韬(Whale Fall·T)</p><p>原文链接: <a href="http://whalesfalling.github.io/2019/03/25/IDEA-SPringBoot-H5WXZF.html">http://whalesfalling.github.io/2019/03/25/IDEA-SPringBoot-H5WXZF.html</a></p><p>版权声明: 转载请注明出处(必须保留原文作者署名原文链接)</p></blockquote></div><div class="tags"><a href="/tags/H5微信支付/">H5微信支付</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2019/03/18/IDEA-Spring-boot-Mybatis.html" class="next">IDEA Spring boot Mybatis 整合</a></div><div id="comments"><div id="SOHUCS" sid="2019/03/25/IDEA-SPringBoot-H5WXZF.html"></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#场景介绍"><span class="toc-text">场景介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集成H5微信支付"><span class="toc-text">集成H5微信支付</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-导入依赖jar包"><span class="toc-text">1.导入依赖jar包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-application-yml"><span class="toc-text">2. application.yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-WebMvcConfiguration"><span class="toc-text">3. WebMvcConfiguration</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-MyWXPayConfig"><span class="toc-text">4. MyWXPayConfig</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-WXPayClient"><span class="toc-text">5. WXPayClient</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-WXPayConfiguration"><span class="toc-text">6. WXPayConfiguration</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-gotoH5Page-html"><span class="toc-text">7. gotoH5Page.html</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-h5PaySuccess-html"><span class="toc-text">8. h5PaySuccess.html</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-WXPayH5PayController"><span class="toc-text">9. WXPayH5PayController</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常见问题"><span class="toc-text">常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Data-Slf4j标签的引用"><span class="toc-text">1.@Data @Slf4j标签的引用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-微信支付常见错误"><span class="toc-text">2.微信支付常见错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-沙箱环境说明"><span class="toc-text">3.沙箱环境说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回调页面"><span class="toc-text">回调页面</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/03/25/IDEA-SPringBoot-H5WXZF.html">IDEA SPringBoot 整合H5微信支付</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/18/IDEA-Spring-boot-Mybatis.html">IDEA Spring boot Mybatis 整合</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/16/hello-world.html">Hello World</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/H5微信支付/" style="font-size: 15px;">H5微信支付</a> <a href="/tags/SPringBoot整合/" style="font-size: 15px;">SPringBoot整合</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://github.com/whalesfalling" title="whalesfalling" target="_blank">whalesfalling</a><ul></ul><a href="https://github.com/chaooo/hexo-theme-BlueLake" title="BlueLake主题" target="_blank">BlueLake主题</a><ul></ul><a href="https://whalesfalling.github.io/about/" title="Whale Fall·T" target="_blank">Whale Fall·T</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">罗韬(Whale Fall·T).</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?a828e3ada732ae9c4af1433beba4857f";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script><script>window._config = { showScore: true };
(function(){ 
  var appid = 'cyu8ump11'; 
  var conf = 'prod_d4e8e9797bb22c3cdb23c9cdb8bc23b4'; 
  var width = window.innerWidth || document.documentElement.clientWidth; 
  var nodes =document.getElementsByTagName("head")[0]||document.head||document.documentElement;
  if (/(Android|iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent) && width < 750) {  
      window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>');
  }
  else { 
    var loadJs=function(d,a){
      var b=document.createElement("script");b.setAttribute("type","text/javascript");
      b.setAttribute("charset","UTF-8");
      b.setAttribute("src",d);
      if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}
      nodes.appendChild(b)
    };
    loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); 
  } 
  var loadCss = function(cssString){  
    var style=document.createElement("style");  
    style.setAttribute("type", "text/css");  
    if(style.styleSheet){// IE  
        style.styleSheet.cssText = cssString;  
    } else {// w3c  
        var cssText = document.createTextNode(cssString);  
        style.appendChild(cssText);  
    }
    nodes.appendChild(style);
  }
  window.onload=function(){loadCss('.module-hot-topic,.module-cmt-float-bar{display:none!important}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .cbox-prompt-w span.prompt-empty-w,#SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-form-w .form-text-w span.text-null,#SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-minwidth-w div.cont-comment-w a.comment-link-w,#SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-minwidth-w div.cont-comment-w span.comment-text-w,#SOHUCS #SOHU_MAIN .module-cmt-footer .section-service-w div.service-wrap-w a:hover,#SOHUCS #SOHU_MAIN .module-cmt-header .section-cbox-w .block-head-w div.header-login,#SOHUCS #SOHU_MAIN .module-cmt-header .section-title-w .title-user-w .user-wrap-w span.wrap-name-w,#SOHUCS #SOHU_MAIN .module-cmt-list .action-click-gw span.click-disable-eg a em.icon-name-bg,#SOHUCS #SOHU_MAIN .module-cmt-list .block-title-gw ul li div.title-name-gw,#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .cmt-list-number .comment-number span.cy-number,#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .cmt-list-number span.comment-number,#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .type-lists li.active,#SOHUCS #SOHU_MAIN .module-cmt-list .msg-wrap-gw .wrap-action-gw .action-click-gw span a:hover,#SOHUCS #SOHU_MAIN .module-cmt-list .picture-box-gw div.box-action-gw a:hover,#SOHUCS #SOHU_MAIN .module-cmt-list .wrap-action-gw .action-click-gw span a:hover em.icon-name-bg,#SOHUCS #SOHU_MAIN .module-cmt-list .wrap-user-gw span.user-name-gw a{color:#40759b!important}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .post-wrap-border-t div.post-wrap-border-t-r,#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w div.post-wrap-border-l,#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w div.post-wrap-border-r{display:none!important}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .post-wrap-border-t div.post-wrap-border-t-l{background:#FFF!important;top:-2px!important}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-function-w .uploading-wrapper-dw div.wrapper-image-dw,#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w div.post-wrap-main,#SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-form-w div.form-text-w,#SOHUCS #SOHU_MAIN .module-cmt-header .section-cbox-w .block-head-w div.header-login,#SOHUCS #SOHU_MAIN .module-cmt-list .module-cmt-box .post-wrap-w div.post-wrap-main{border:1px solid #e6e6e6!important;border-radius:20px 20px 20px 20px;margin:0!important}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-issue-w .issue-btn-w a .btn-fw{width:130px!important;height:34px!important;line-height:33px!important;font-size:17px!important;background:#5483b1!important;border-radius:20px!important;color:#FFF!important;-webkit-box-shadow:0 -1px 4px #5483b1 inset;box-shadow:0 -1px 10px #5483b1 inset}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-issue-w .issue-btn-w a .btn-fw:before{content:"发表评论"}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-issue-w .issue-btn-w a:hover .btn-fw{color:#40759b!important;background:#FFF!important}#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .type-lists li{background:none!important;border-bottom:1px solid #e6e6e6}#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .type-lists li.active{border:1px solid #e6e6e6;border-radius:10px 10px 0 0;border-bottom:none}#SOHUCS #SOHU_MAIN .module-cmt-list .block-title-gw ul li .title-name-gw div.title-name-gw-tag{background:#5483b1!important;border-radius:3px}#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type div.cmt-list-border{background-color:#e6e6e6!important}#SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item{border:1px solid #e6e6e6!important}#SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item .nt-logo{text-align:center;line-height:40px;border-radius:50%!important;background:#e6e6e6!important}#SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item .nt-logo:before{content:"畅";font-size:22px;color:#FFF}#SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item a.nt-text,#SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item a.nt-text i{color:#5483b1!important}#SOHUCS #SOHU_MAIN .module-cmt-header .section-title-w .title-user-w .user-wrap-w{background:#FFF!important}@media screen and (min-width:900px){#SOHUCS #SOHU_MAIN .module-mobile-cmt-list .list-wrapper-wap .list-container-wap .list-item-wap .list-content-wrapper-wap .cmt-list-image-container .cmt-list-image{max-width: 100%;}}');};
})();
function removeElement(_element){
     var _parentElement = _element.parentNode;
     if(_parentElement){
            _parentElement.removeChild(_element);
     }
}
var removeAD = document.createElement("div");
removeAD.id = 'removeAD';
var adInterval1 = setInterval(function() {
  if(document.querySelector("#feedAv")){
    document.querySelector("[node-type=cmt-list]").appendChild(removeAD);
    document.querySelector("#removeAD").appendChild(document.querySelector("#feedAv"));
    removeElement(document.querySelectorAll("#feedAv")[0]);
    document.querySelector("#removeAD").style.display="none"
    clearInterval(adInterval1);
  }
},1000);
var adInterval2 = setInterval(function() {
  if(document.querySelector("#pop_ad")){
    removeElement(document.querySelector("#pop_ad"));
    clearInterval(adInterval2);
  }
}, 1000);</script><script src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script></body></html>